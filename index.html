<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Modern jQuery: Refactoring and Testing the Way Forward</title>

    <meta name="description" content="Modern jQuery: Refactoring and Testing the Way Forward">
    <meta name="author" content="Ken Dale">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <section>
          <p>Modern jQuery: Refactoring and Testing the Way Forward</p>
          <br />
          <p><a href="http://kendaleiv.com">Ken Dale</a> / <a href="http://twitter.com/kendaleiv">@kendaleiv</a></p>
        </section>

        <section>
          <a href="https://trends.builtwith.com/javascript/jQuery">https://trends.builtwith.com/javascript/jQuery</a>
        </section>

        <section>
          <h2>Rewrites</h2>
        </section>

        <section>
          <a href="https://www.google.com/search?q=should+i+rewrite">https://www.google.com/search?q=should+i+rewrite</a>
        </section>

        <section>
          <p>Opinions, choose your own adventure, YRMV, etc.</p>
        </section>

        <section>
          <code>&lt;/meta&gt;</code>
        </section>

        <section>
          <h2>Goal: Betterify this</h2>
          <pre class="stretch"><code data-trim contenteditable>
$(document).ready(function () {
  $('#fetch').click(function () {
    var stockSymbol = $.trim($('#stock-symbol').val().toUpperCase());

    $.ajax('some_long_url', {
      beforeSend: function() {
        $('#current-stock-price').html('Loading ...');
      },
      success: function (res) {
        var quote = $(res).find('[symbol="' + stockSymbol + '"]');
        var lastTradePrice = quote.find('LastTradePriceOnly').text();

        $('#current-stock-price').html('<strong>' + stockSymbol + '</strong>: $' + lastTradePrice + ' retrieved at ' + new Date().toString());
        $('#stock-price-log').html($('#stock-price-log').html() + '<li><strong>' + stockSymbol + '</strong> $' + lastTradePrice + ' retrieved at ' + new Date().toString() + '</li>');
      }
    });
  });
});
          </code></pre>
          <a href="https://github.com/kendaleiv/jquery-js-refactor/blob/c261e39b3291fc7a88c6accd0182a381917e776b/index.html">View on GitHub</a>
          <aside class="notes">
            <p>Talk through talking about the application itself</p>
            <p>Issues include:</p>
            <ul>
              <li>
                Mixing concerns between UI, AJAX, and overall application flow.
                Could result in an unmaintainable mess as more features are implemented.
                Writing tests against this code may be possible, but could be difficult.
              </li>
              <li>Non-cached jQuery selectors</li>
              <li>Opportunities for shorthand usage and/or better jQuery syntax.</li>
            </ul>
          </aside>
        </section>

        <section>
          <h2>Why?</h2>
        </section>

        <section>
          <img src="https://i.chzbgr.com/maxW500/1441938176/h9103CEC9/" />
        </section>

        <section>
          <p>Maintainability, testability, warm fuzzies</p>
        </section>

        <section>
          <p>External files, strict mode, IIFE</p>
          <br />
          <br />
          <br />
          <br />
          <p class="fragment"><strong><code>import { something } from 'somewhere';</code></strong></p>
        </section>

        <section>
          <p>Continue using jQuery</p>
        </section>

        <section>
          <p>Or, switch to something else</p>
          <br />
          <br />
          <br />
          <small>(<code>fetch</code>, etc.)</small>
        </section>

        <section>
          <h2>You decide</h2>
        </section>

        <section>
          <h1>Prepare Yourself</h1>
          <br />
          <br />
          <br />
          <br />
          <br />
          <p>Refactoring ahead</p>
        </section>

        <section style="font-size: 30px;">
          <pre style="margin-top: -50px;"><code data-trim contenteditable>
$.ajax(url).done(function (res) {
  var quote = $(res).find('[symbol="' + stockSymbol + '"]');
  var lastTradePrice = quote.find('LastTradePriceOnly').text();

  // More code not related to getting the lastTradePrice
});
          </code></pre>
          <pre><code style="max-height: 570px;" data-trim contenteditable>
// data-provider.js
import $ from 'jquery';

export default class DataProvider {
  getStockPrice(stockSymbol) {
    if (!stockSymbol) {
      throw new Error('Must provide a stockSymbol');
    }

    const url = 'http://query.yahooapis.com/v1/public/yql'
      + `?q=select * from yahoo.finance.quotes where symbol in ("${stockSymbol}")`
      + '&diagnostics=true'
      + '&env=http://datatables.org/alltables.env';

    return fetch(url)
      .then(res => res.text())
      .then(text => {
        const quote = $(text).find(`[symbol="${stockSymbol}"]`);
        const lastTradePrice = quote.find('LastTradePriceOnly').text();

        return lastTradePrice;
      });
  }
}

// Usage:
new DataProvider().getStockPrice('MSFT').then(lastTradePrice => {
  /* Code here */
});
          </code></pre>
        </section>

        <section>
          <h2>Lather, rinse, repeat</h2>
          <br />
          <p>
            If you want to explore further refactoring
            <br />
            examine
            <a href="https://github.com/kendaleiv/jquery-js-refactor/blob/c261e39b3291fc7a88c6accd0182a381917e776b/index.html">start</a>
            and
            <a href="https://github.com/kendaleiv/jquery-js-refactor/tree/modern-js">finish</a>.
          </p>
        </section>

        <section>
          <h2>Start the app</h2>
          <p>Single obvious way to make it work.</p>
          <pre><code data-trim contenteditable>
import StockRetriever from './stock-retriever';
import DataProvider from './data-provider';
import UiProvider from './ui-provider';

new StockRetriever(new DataProvider(), new UiProvider())
  .init();
          </code></pre>
        </section>

        <section>
          <h2>Testing</h2>
          <img src="https://i.chzbgr.com/maxW500/7974209024/hDB968B9D/" />
          <p>Add tests while you refactor</p>
        </section>

        <section>
          <h2>Testing with AVA</h2>
          <pre><code data-trim contenteditable>
import test from 'ava';

test('simple test', t => {
  t.true(true);
});
          </code></pre>
          <br />
          <small>Jasmine is nice, too!</small>
        </section>

        <section>
          <h2>AVA: Promises</h2>
          <pre><code data-trim contenteditable>
import test from 'ava';

test('should return stock price', t => {
  return new DataProvider()
    .getStockPrice('TEST')
    .then(lastTradePrice => {
      t.is(lastTradePrice, '123.45');
    });
});
          </code></pre>
        </section>

        <section>
          <h2>fetch-mock</h2>
          <pre class="stretch"><code data-trim contenteditable>
import test from 'ava';
import fetchMock from 'fetch-mock';

import DataProvider from '../src/data-provider';

test.beforeEach(() => {
  const response = `<?xml version="1.0" encoding="UTF-8"?>
<query><results><quote symbol="TEST"><LastTradePriceOnly>123.45</LastTradePriceOnly></quote></results></query>`;

  fetchMock.get('*', response);
});

test.afterEach(() => {
  fetchMock.restore();
});

test('should return stock price', t => {
  return new DataProvider()
    .getStockPrice('TEST')
    .then(lastTradePrice => {
      t.is(lastTradePrice, '123.45');
    });
});
          </code></pre>
        </section>

        <section>
          AVA: Using jQuery with the DOM
        </section>

        <section>
          <pre><code data-trim contenteditable>
// https://github.com/avajs/ava/blob/20ab39de046e527dec7b369f375d6c8e5fd4f5e1/docs/recipes/browser-testing.md#setup-jsdom

global.document = require('jsdom').jsdom('<body></body>');
global.window = document.defaultView;
global.navigator = window.navigator;
          </code></pre>
        </section>

        <section>
          <h2>Code</h2>
          <br />
          <p><a href="https://github.com/kendaleiv/jquery-js-refactor/blob/c261e39b3291fc7a88c6accd0182a381917e776b/index.html">Start</a></p>
          <h2>&darr;</h2>
          <p><a href="https://github.com/kendaleiv/jquery-js-refactor/tree/modern-js">Finish</a></p>
        </section>

        <section>
          <h2>Surprise!</h2>
          <br />
          <p class="fragment">You just learned a language agnostic skill!</p>
        </section>

        <section>
          <h2>Quick recap</h2>
          <br />
          <ul>
            <li class="fragment">Refactor into modules (or, any <em>modular</em> approach).</li>
            <li class="fragment">Make decisions along the way.</li>
            <li class="fragment">Add tests, too!</li>
          </ul>
          <br />
          <br />
          <br />
          <br />
          <br />
          <p class="fragment"><strong>Congratulations: You've reached the next level!</strong></p>
        </section>

        <section>
          <a href="https://github.com/kendaleiv/jquery-js-refactor">https://github.com/kendaleiv/jquery-js-refactor</a>
          <br />
          <br />
          <br />
          <br />
          <br />
          <h2>Questions?</h2>
          <p><a href="http://kendaleiv.com">Ken Dale</a> / <a href="http://twitter.com/kendaleiv">@kendaleiv</a></p>
        </section>

      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: false,
        progress: false,
        history: true,
        center: true,

        transition: 'none', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
